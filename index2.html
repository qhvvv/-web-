<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>信用卡web管理系统</title>
  <style>
    :root{
      --bg:#f3f6fb;
      --surface:#ffffff;
      --muted:#6b7280;
      --text:#0f172a;
      --accent:#1e3a8a;
      --accent-2:#1e40af;
      --danger:#dc2626;
      --radius:8px;
      --shadow: 0 6px 18px rgba(16,24,40,0.06);
      font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
    }

    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-size:14px}
    .topbar{height:64px;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;display:flex;align-items:center;padding:0 24px}
    .brand{font-weight:700;font-size:16px;letter-spacing:0.2px}
    .top-actions{margin-left:auto;display:flex;gap:12px;align-items:center}
    .top-actions .user{background:transparent;border:1px solid rgba(255,255,255,0.12);padding:8px 12px;border-radius:6px}
    .layout{display:flex;max-width:1100px;margin:20px auto;padding:0 16px;gap:16px}
    .sidebar{width:220px;background:var(--surface);border-radius:10px;padding:12px;box-shadow:var(--shadow);height:calc(100vh - 140px);}
    .sidebar .menu{list-style:none;padding:0;margin:0}
    .sidebar .menu li{padding:10px 12px;border-radius:6px;color:var(--muted);cursor:pointer}
    .sidebar .menu li.active{background:linear-gradient(90deg, rgba(30,58,138,0.06), rgba(30,64,175,0.04));color:var(--accent);font-weight:600}
    .main{flex:1}
    .card{background:var(--surface);padding:16px;border-radius:10px;box-shadow:var(--shadow);margin-bottom:16px}
    .toolbar{display:flex;align-items:center;gap:12px}
    .search{flex:1;display:flex;align-items:center;background:#f8fafc;border:1px solid #e6eef7;padding:8px;border-radius:8px}
    .search input{border:0;background:transparent;outline:none;width:100%}
    .btn{background:var(--accent);color:white;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid #e6eef7;color:var(--text)}
    table{width:100%;border-collapse:collapse}
    thead th{text-align:left;padding:12px 8px;color:var(--muted);font-size:12px;border-bottom:1px solid #eef3fb}
    tbody td{padding:12px 8px;border-bottom:1px solid #f3f6fb}
    .actions button{margin-right:8px}
    .stat-grid{display:flex;gap:12px}
    .stat{flex:1;padding:12px;border-radius:8px;background:linear-gradient(180deg,#ffffff,#fbfdff);box-shadow:0 4px 12px rgba(16,24,40,0.04)}
    .muted{color:var(--muted);font-size:12px}
    .big{font-size:20px;font-weight:700}
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center;padding:16px}
    .modal{width:100%;max-width:640px;background:var(--surface);padding:20px;border-radius:10px;box-shadow:0 10px 30px rgba(2,6,23,0.35)}
    .form-row{display:flex;gap:12px}
    .form-row .col{flex:1}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input,select,textarea{width:100%;padding:10px;border:1px solid #e6eef7;border-radius:8px;background:transparent}
    .modal-footer{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}
    @media (max-width:900px){
      .layout{flex-direction:column;padding:8px}
      .sidebar{width:100%;height:auto}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">个人信用卡管理</div>
    <div class="top-actions">
      <div id="currentUser" class="user">用户</div>
      <button id="btnNew" style="background:white;color:var(--accent);">新增卡片</button>
    </div>
  </div>

  <div class="layout">
    <aside class="sidebar">
      <ul class="menu" id="menu">
        <li data-page="cards" class="active">信用卡管理</li>
        <li data-page="stats">统计报表</li>
        <li data-page="settings">用户设置</li>
      </ul>

      
    </aside>
    <main class="main">
      <section id="page-cards">
        <div class="card">
          <div class="toolbar">
            <div class="search"><input id="search" placeholder="搜索 卡号 / 持卡人 / 银行" /></div>
            <select id="filterBank" style="padding:8px;border-radius:8px;border:1px solid #e6eef7;background:white">
              <option value="">全部银行</option>
            </select>
            <button id="clearBtn" class="btn ghost">清除筛选</button>
          </div>
        </div>

        <div class="card">
          <table>
            <thead>
              <tr><th>持卡人</th><th>卡号</th><th>银行</th><th>有效期</th><th>备注</th><th>操作</th></tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </section>
	  
      <section id="page-stats" style="display:none">
        <div class="stat-grid">
          <div class="stat">
            <div class="muted">总卡数</div>
            <div class="big" id="statCount">0</div>
          </div>
          <div class="stat">
            <div class="muted">常用银行数</div>
            <div class="big" id="statBanks">0</div>
          </div>
          <div class="stat">
            <div class="muted">最近新增</div>
            <div class="big" id="statRecent">—</div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h4>按银行分布（柱状图）</h4>
          <canvas id="bankChart" width="800" height="240" style="width:100%;height:240px"></canvas>
        </div>
      </section>

      <section id="page-settings" style="display:none">
        <div class="card">
          <h3>个人信息</h3>
          <div style="margin-top:12px">
            <label>用户名</label>
            <input id="profileName" placeholder="显示名称" />
          </div>
          <div style="margin-top:12px">
            <label>邮箱</label>
            <input id="profileEmail" placeholder="邮箱（可选）" />
          </div>
          <div style="margin-top:12px" class="modal-footer">
            <button id="saveProfile" class="btn">保存</button>
          </div>
        </div>
      </section>
    </main>
  </div>


  <div id="modalEdit" class="modal-backdrop">
    <div class="modal">
      <h3 id="editTitle">新增信用卡</h3>
      <div style="margin-top:8px">
        <div class="form-row">
          <div class="col">
            <label>持卡人姓名</label>
            <input id="holder" placeholder="例如：ZHANG SAN" />
          </div>
          <div class="col">
            <label>银行</label>
            <input id="bank" placeholder="例如：中国银行" />
          </div>
        </div>

        <div style="margin-top:12px" class="form-row">
          <div class="col">
            <label>卡号</label>
            <input id="number" placeholder="仅数字，自动格式化" />
          </div>
          <div style="width:140px">
            <label>到期月 (MM)</label>
            <input id="expMonth" placeholder="MM" />
          </div>
          <div style="width:120px">
            <label>到期年 (YY)</label>
            <input id="expYear" placeholder="YY" />
          </div>
        </div>

        <div style="margin-top:12px">
          <label>备注</label>
          <input id="note" />
        </div>

        <div class="modal-footer">
          <button id="editCancel" class="btn ghost">取消</button>
          <button id="editSave" class="btn">保存</button>
        </div>
      </div>
    </div>
  </div>

  <script>

    const LS_CARDS = 'user_cc_cards_v1';
    const LS_PROFILE = 'user_cc_profile_v1';

    let cards = [];
    let editingId = null;

    const menu = document.getElementById('menu');
    const pages = {cards: document.getElementById('page-cards'), stats: document.getElementById('page-stats'), settings: document.getElementById('page-settings')};
    const tableBody = document.getElementById('tableBody');
    const filterBank = document.getElementById('filterBank');
    const searchInput = document.getElementById('search');
    const currentUser = document.getElementById('currentUser');


    function uid(){return Date.now().toString(36)+Math.random().toString(36).slice(2,8)}
    function saveCards(){localStorage.setItem(LS_CARDS, JSON.stringify(cards))}
    function loadCards(){try{cards = JSON.parse(localStorage.getItem(LS_CARDS))||[]}catch(e){cards=[]}}
    function saveProfile(p){localStorage.setItem(LS_PROFILE, JSON.stringify(p))}
    function loadProfile(){try{return JSON.parse(localStorage.getItem(LS_PROFILE))||{}}catch(e){return {}}}

    function luhnCheck(num){const s=num.replace(/\D/g,'');let sum=0,alt=false;for(let i=s.length-1;i>=0;i--){let n=parseInt(s[i],10);if(alt){n*=2;if(n>9)n-=9}sum+=n;alt=!alt;}return sum%10===0}
    function formatNumber(v){return v.replace(/\D/g,'').slice(0,19).replace(/(.{4})/g,'$1 ').trim()}
    function maskNumber(v){const s=v.replace(/\D/g,'');if(s.length<=8) return s.replace(/.(?=.{4})/g,'*');return s.replace(/\d(?=\d{4})/g,'*').replace(/(.{4})/g,'$1 ').trim()}
    function escapeHtml(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}


    menu.addEventListener('click',(e)=>{
      const li = e.target.closest('li'); if(!li) return; const page = li.dataset.page;
      for(const node of menu.querySelectorAll('li')) node.classList.remove('active');
      li.classList.add('active');
      for(const k in pages){pages[k].style.display = (k===page)?'block':'none'}
      if(page==='stats') renderStats();
      if(page==='settings') loadProfileToUI();
    });

    function render(filter=''){
      const q = filter.trim().toLowerCase();
      tableBody.innerHTML = '';
      const list = cards.filter(c=>{if(!q) return true; return (c.holder||'').toLowerCase().includes(q) || (c.bank||'').toLowerCase().includes(q) || (c.number||'').replace(/\s/g,'').includes(q.replace(/\s/g,''));});
      for(const c of list){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(c.holder||'—')}</td>
                        <td>${escapeHtml(maskNumber(c.number||''))}</td>
                        <td>${escapeHtml(c.bank||'—')}</td>
                        <td>${escapeHtml((c.expMonth||'--')+'/'+(c.expYear||'--'))}</td>
                        <td>${escapeHtml(c.note||'')}</td>
                        <td class="actions">
                          <button class="btn ghost" data-id="${c.id}" data-action="edit">编辑</button>
                          <button class="btn" style="background:var(--danger)" data-id="${c.id}" data-action="del">删除</button>
                        </td>`;
        tableBody.appendChild(tr);
      }


      document.getElementById('statCount').textContent = cards.length;
      const banks = Array.from(new Set(cards.map(c=>c.bank).filter(Boolean)));
      document.getElementById('statBanks').textContent = banks.length;
      document.getElementById('statRecent').textContent = cards.length ? new Date(cards[0].createdAt).toLocaleDateString() : '—';


      const bankOptions = [''].concat(banks.sort());
      filterBank.innerHTML = bankOptions.map(b=>`<option value="${escapeHtml(b)}">${b?b:'全部银行'}</option>`).join('');


      const prof = loadProfile(); currentUser.textContent = prof.name || '用户';
    }


    tableBody.addEventListener('click',(e)=>{
      const btn = e.target.closest('button'); if(!btn) return; const id = btn.dataset.id; const action = btn.dataset.action;
      if(action==='edit') openEdit(id);
      if(action==='del'){ if(confirm('确定删除该卡？')){cards = cards.filter(c=>c.id!==id); saveCards(); render(searchInput.value);} }
    });


    const modalEdit = document.getElementById('modalEdit');
    function openEditModal(){modalEdit.style.display='flex'}
    function closeEditModal(){modalEdit.style.display='none'; editingId=null; document.getElementById('editTitle').textContent='新增信用卡'; document.getElementById('holder').value=''; document.getElementById('bank').value=''; document.getElementById('number').value=''; document.getElementById('expMonth').value=''; document.getElementById('expYear').value=''; document.getElementById('note').value='';}
    document.getElementById('btnNew').addEventListener('click', ()=>{openEditModal();});

    function openEdit(id){const c = cards.find(x=>x.id===id); if(!c) return; editingId=id; document.getElementById('editTitle').textContent='编辑信用卡'; document.getElementById('holder').value=c.holder||''; document.getElementById('bank').value=c.bank||''; document.getElementById('number').value=formatNumber(c.number||''); document.getElementById('expMonth').value=c.expMonth||''; document.getElementById('expYear').value=c.expYear||''; document.getElementById('note').value=c.note||''; openEditModal();}

    document.getElementById('editCancel').addEventListener('click', ()=>closeEditModal());
    document.getElementById('number').addEventListener('input',(e)=>{e.target.value = formatNumber(e.target.value)});

    document.getElementById('editSave').addEventListener('click', ()=>{
      const holder = document.getElementById('holder').value.trim();
      const bank = document.getElementById('bank').value.trim();
      const number = document.getElementById('number').value.replace(/\s/g,'');
      const expMonth = document.getElementById('expMonth').value.trim();
      const expYear = document.getElementById('expYear').value.trim();
      const note = document.getElementById('note').value.trim();

      if(!holder||!number||!expMonth||!expYear){alert('请填写必填项：持卡人、卡号、到期月、到期年');return}
      if(!/^\d{12,19}$/.test(number)){alert('卡号需为 12-19 位数字');return}
      if(!luhnCheck(number)){if(!confirm('Luhn 校验未通过，是否仍然保存？')) return}

      if(editingId){
        const idx = cards.findIndex(c=>c.id===editingId);
        if(idx!==-1){cards[idx] = {...cards[idx], holder, bank, number, expMonth, expYear, note};}
      }else{
        const obj = {id:uid(), holder, bank, number, expMonth, expYear, note, createdAt:new Date().toISOString()};
        cards.unshift(obj);
      }
      saveCards(); render(searchInput.value); closeEditModal();
    });

    searchInput.addEventListener('input',(e)=>render(e.target.value));
    filterBank.addEventListener('change',(e)=>{const v=e.target.value; if(!v) render(searchInput.value); else render_via_bank(v)});
    document.getElementById('clearBtn').addEventListener('click', ()=>{searchInput.value=''; filterBank.value=''; render();});

    function render_via_bank(bank){tableBody.innerHTML=''; const list = cards.filter(c=>c.bank===bank); for(const c of list){const tr=document.createElement('tr'); tr.innerHTML=`<td>${escapeHtml(c.holder||'—')}</td><td>${escapeHtml(maskNumber(c.number||''))}</td><td>${escapeHtml(c.bank||'—')}</td><td>${escapeHtml((c.expMonth||'--')+'/'+(c.expYear||'--'))}</td><td>${escapeHtml(c.note||'')}</td><td class="actions"><button class="btn ghost" data-id="${c.id}" data-action="edit">编辑</button><button class="btn" style="background:var(--danger)" data-id="${c.id}" data-action="del">删除</button></td>`; tableBody.appendChild(tr);} document.getElementById('statCount').textContent = cards.length; document.getElementById('statBanks').textContent = Array.from(new Set(cards.map(c=>c.bank).filter(Boolean))).length; document.getElementById('statRecent').textContent = cards.length ? new Date(cards[0].createdAt).toLocaleDateString() : '—';}
    function renderStats(){
      const ctx = document.getElementById('bankChart').getContext('2d');
      const counts = {};
      for(const c of cards){ if(!c.bank) continue; counts[c.bank] = (counts[c.bank]||0)+1 }
      const banks = Object.keys(counts);
      const values = banks.map(b=>counts[b]);
      const max = Math.max(1, ...values);


      ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);

      const w = ctx.canvas.width; const h = ctx.canvas.height; const padding=40; const chartW = w - padding*2; const chartH = h - padding*2;
      ctx.fillStyle = '#fff'; ctx.fillRect(0,0,w,h);
      ctx.fillStyle = '#94a3b8'; ctx.font='12px sans-serif';


      const barW = banks.length ? (chartW / banks.length * 0.6) : 0;
      banks.forEach((b,i)=>{
        const x = padding + i*(chartW/banks.length) + (chartW/banks.length - barW)/2;
        const barH = (values[i]/max) * (chartH - 20);
        const y = padding + (chartH - barH);
        
        ctx.fillStyle = '#1e3a8a';
        ctx.fillRect(x, y, barW, barH);

        ctx.fillStyle = '#334155'; ctx.textAlign='center'; ctx.fillText(b, x + barW/2, padding + chartH + 14);

        ctx.fillText(values[i], x + barW/2, y - 6);
      });
      if(banks.length===0){ctx.fillStyle='#64748b'; ctx.textAlign='center'; ctx.fillText('无数据', w/2, h/2)}
    }


    function loadProfileToUI(){const p = loadProfile(); document.getElementById('profileName').value = p.name || ''; document.getElementById('profileEmail').value = p.email || ''; currentUser.textContent = p.name || '用户'}
    document.getElementById('saveProfile').addEventListener('click', ()=>{const p={name:document.getElementById('profileName').value.trim(), email:document.getElementById('profileEmail').value.trim()}; saveProfile(p); alert('已保存'); currentUser.textContent = p.name || '用户'});


    function seedIfEmpty(){if(cards.length===0){cards=[{id:uid(),holder:'ZHANG SAN',number:'4111111111111111',bank:'示例银行',expMonth:'12',expYear:'26',note:'测试卡',createdAt:new Date().toISOString()},{id:uid(),holder:'LI HUA',number:'5555555555554444',bank:'国内银行',expMonth:'06',expYear:'27',note:'工资卡',createdAt:new Date().toISOString()}]; saveCards();}}
    loadCards(); seedIfEmpty(); render();
    document.getElementById('modalEdit').addEventListener('click',(e)=>{ if(e.target===document.getElementById('modalEdit')) closeEditModal(); });

  </script>
</body>
</html>
