<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>信用卡管理系统（增强版）</title>
<style>
:root{
  --bg:#f3f6fb;
  --surface:#ffffff;
  --muted:#6b7280;
  --text:#0f172a;
  --accent:#1e3a8a;
  --accent-2:#1e40af;
  --danger:#dc2626;
  --radius:8px;
  --shadow: 0 6px 18px rgba(16,24,40,0.06);
  font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-size:14px}
.topbar{height:64px;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;display:flex;align-items:center;padding:0 24px}
.brand{font-weight:700;font-size:16px;letter-spacing:0.2px}
.top-actions{margin-left:auto;display:flex;gap:8px;align-items:center}
.top-actions .user{background:transparent;border:1px solid rgba(255,255,255,0.12);padding:8px 12px;border-radius:6px}
.layout{display:flex;max-width:1200px;margin:18px auto;padding:0 16px;gap:16px}
.sidebar{width:260px;background:var(--surface);border-radius:10px;padding:12px;box-shadow:var(--shadow);height:calc(100vh - 120px);display:flex;flex-direction:column;justify-content:space-between}
.menu{list-style:none;padding:0;margin:0}
.menu li{padding:10px 12px;border-radius:6px;color:var(--muted);cursor:pointer}
.menu li.active{background:linear-gradient(90deg, rgba(30,58,138,0.06), rgba(30,64,175,0.04));color:var(--accent);font-weight:600}
.extra{margin-top:16px;font-size:13px;color:var(--muted)}
.extra h4{margin:8px 0;color:var(--accent);font-size:14px}
.main{flex:1}
.card{background:var(--surface);padding:16px;border-radius:10px;box-shadow:var(--shadow);margin-bottom:16px}
.toolbar{display:flex;align-items:center;gap:12px}
.search{flex:1;display:flex;align-items:center;background:#f8fafc;border:1px solid #e6eef7;padding:8px;border-radius:8px}
.search input{border:0;background:transparent;outline:none;width:100%}
.btn{background:var(--accent);color:white;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid #e6eef7;color:var(--text)}
.table{width:100%;border-collapse:collapse}
.table thead th{text-align:left;padding:12px 8px;color:var(--muted);font-size:12px;border-bottom:1px solid #eef3fb}
.table tbody td{padding:12px 8px;border-bottom:1px solid #f3f6fb}
.actions button{margin-right:8px}
.stat-grid{display:flex;gap:12px}
.stat{flex:1;padding:12px;border-radius:8px;background:linear-gradient(180deg,#ffffff,#fbfdff);box-shadow:0 4px 12px rgba(16,24,40,0.04)}
.muted{color:var(--muted);font-size:12px}
.big{font-size:20px;font-weight:700}
.modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center;padding:16px}
.modal{width:100%;max-width:760px;background:var(--surface);padding:20px;border-radius:10px;box-shadow:0 10px 30px rgba(2,6,23,0.35)}
.form-row{display:flex;gap:12px}
.form-row .col{flex:1}
label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
input,select,textarea{width:100%;padding:10px;border:1px solid #e6eef7;border-radius:8px;background:transparent}
.modal-footer{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}
mark{background:yellow;color:black}
.tag{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef2ff;color:#1e3a8a;margin-right:6px;margin-bottom:6px;font-size:12px}
.expire-badge{color:var(--danger);font-weight:700}
@media (max-width:1000px){.layout{flex-direction:column;padding:8px}.sidebar{width:100%;height:auto}}
.small-muted{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
  <div class="topbar">
    <div class="brand">信用卡管理系统（增强版）</div>
    <div class="top-actions">
      <div id="currentUser" class="user">用户</div>
      <button id="btnNew" style="background:white;color:var(--accent);">新增卡片</button>
      <button id="btnImport" class="btn ghost">导入</button>
      <button id="btnExport" class="btn ghost">导出</button>
    </div>
  </div>

  <div class="layout">
    <aside class="sidebar">
      <div>
        <ul class="menu" id="menu">
          <li data-page="dashboard" class="active">仪表盘</li>
          <li data-page="cards">信用卡管理</li>
          <li data-page="bills">账单管理</li>
          <li data-page="stats">统计报表</li>
          <li data-page="settings">设置</li>
          <li data-page="security">安全中心</li>
        </ul>

        <div class="extra">
          <h4>默认卡片</h4>
          <div id="defaultCard">未设置</div>
          <h4>到期提醒</h4>
          <div id="expireNotice">无即将到期的卡</div>
          <h4 style="margin-top:12px">快捷入口</h4>
          <div style="display:flex;gap:8px;margin-top:6px">
            <button id="quickUnpaid" class="btn ghost" style="width:100%">未还账单</button>
            <button id="quickPaid" class="btn ghost" style="width:100%">已还账单</button>
          </div>
        </div>
      </div>

      <div class="extra">
        <h4>系统工具</h4>
        <div style="display:flex;gap:8px">
          <button id="clearAll" class="btn ghost" style="flex:1">清空数据</button>
          <button id="seedBtn" class="btn" style="flex:1">重建示例</button>
        </div>
      </div>
    </aside>

    <main class="main">
      <section id="page-dashboard" class="card" style="display:block">
        <div class="stat-grid">
          <div class="stat"><div class="muted">总额度</div><div class="big" id="dashTotal">¥0.00</div></div>
          <div class="stat"><div class="muted">已用额度</div><div class="big" id="dashUsed">¥0.00</div></div>
          <div class="stat"><div class="muted">剩余额度</div><div class="big" id="dashRemain">¥0.00</div></div>
          <div class="stat"><div class="muted">最近新增</div><div class="big" id="dashRecent">—</div></div>
        </div>
        <div class="card" style="margin-top:16px">
          <h4>最近 5 张卡</h4>
          <table class="table">
            <thead><tr><th>持卡人</th><th>卡号</th><th>银行</th><th>标签</th><th>有效期</th></tr></thead>
            <tbody id="dashRecentList"></tbody>
          </table>
        </div>
      </section>

      <section id="page-cards" class="card" style="display:none">
        <div class="toolbar">
          <div class="search"><input id="search" placeholder="搜索 卡号 / 持卡人 / 银行 / 标签" /></div>
          <select id="filterTag" style="padding:8px;border-radius:8px;border:1px solid #e6eef7;background:white">
            <option value="">全部标签</option>
          </select>
          <select id="filterBank" style="padding:8px;border-radius:8px;border:1px solid #e6eef7;background:white">
            <option value="">全部银行</option>
          </select>
          <button id="clearBtn" class="btn ghost">清除筛选</button>
        </div>

        <div class="card" style="margin-top:12px;padding:8px">
          <table class="table">
            <thead><tr><th>持卡人</th><th>卡号</th><th>银行</th><th>标签</th><th>备注</th><th>有效期</th><th>操作</th></tr></thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </section>

      <section id="page-bills" class="card" style="display:none">
        <div class="toolbar">
          <div class="search"><input id="billSearch" placeholder="搜索 卡号 / 账期 / 状态" /></div>
          <select id="billCardFilter" style="padding:8px;border-radius:8px;border:1px solid #e6eef7;background:white">
            <option value="">全部卡</option>
          </select>
          <button id="genAllBills" class="btn ghost">为所有卡生成本月账单</button>
        </div>
        <div class="card" style="margin-top:12px">
          <table class="table">
            <thead><tr><th>卡号</th><th>账期</th><th>金额</th><th>到期</th><th>状态</th><th>操作</th></tr></thead>
            <tbody id="billBody"></tbody>
          </table>
        </div>
      </section>

      <section id="page-stats" class="card" style="display:none">
        <div class="stat-grid">
          <div class="stat"><div class="muted">总卡数</div><div class="big" id="statCount">0</div></div>
          <div class="stat"><div class="muted">常用银行数</div><div class="big" id="statBanks">0</div></div>
          <div class="stat"><div class="muted">含标签卡数</div><div class="big" id="statTagged">0</div></div>
        </div>
        <div class="card" style="margin-top:12px">
          <h4>按银行分布（柱状图）</h4>
          <canvas id="bankChart" width="800" height="240" style="width:100%;height:240px"></canvas>
        </div>
      </section>

      <section id="page-settings" class="card" style="display:none">
        <h3>个人信息</h3>
        <div style="margin-top:12px"><label>用户名</label><input id="profileName" placeholder="显示名称" /></div>
        <div style="margin-top:12px"><label>邮箱</label><input id="profileEmail" placeholder="邮箱（必填）" /></div>
        <div class="modal-footer"><button id="saveProfile" class="btn">保存</button></div>
      </section>

      <section id="page-security" class="card" style="display:none">
        <h3>安全中心</h3>
        <div style="margin-top:12px"><label>是否启用强密码（至少 8 位，含大小写、数字、特殊字符）</label><select id="strongToggle"><option value="0">关闭</option><option value="1">开启</option></select></div>
        <div style="margin-top:12px"><label>修改登录密码</label><input id="pwOld" placeholder="旧密码" /></div>
        <div style="margin-top:12px"><input id="pwNew" placeholder="新密码" /></div>
        <div style="margin-top:12px" class="modal-footer"><button id="savePassword" class="btn">修改密码</button></div>
      </section>

    </main>
  </div>

  <div id="modalEdit" class="modal-backdrop">
    <div class="modal">
      <h3 id="editTitle">新增信用卡</h3>
      <div style="margin-top:8px">
        <div class="form-row">
          <div class="col"><label>持卡人姓名</label><input id="holder" /></div>
          <div class="col"><label>银行</label><input id="bank" /></div>
        </div>
        <div style="margin-top:12px" class="form-row">
          <div class="col"><label>卡号</label><input id="number" placeholder="仅数字，自动格式化" /></div>
          <div style="width:140px"><label>到期月 (MM)</label><input id="expMonth" /></div>
          <div style="width:120px"><label>到期年 (YY)</label><input id="expYear" /></div>
        </div>
        <div style="margin-top:12px"><label>标签（逗号分隔）</label><input id="tags" placeholder="例如：工资卡,网购" /></div>
        <div style="margin-top:12px"><label>备注</label><input id="note" /></div>
        <div class="modal-footer">
          <button id="editCancel" class="btn ghost">取消</button>
          <button id="editSave" class="btn">保存</button>
        </div>
      </div>
    </div>
  </div>

<script>
const LS_CARDS='user_cc_cards_v2',LS_BILLS='user_cc_bills_v1',LS_PROFILE='user_cc_profile_v1',LS_DEFAULT='user_cc_default_v1',LS_SETTINGS='user_cc_settings_v1',LS_PASSWORD='user_cc_pw_v1';
let cards=[],bills=[];
const menu=document.getElementById('menu'),pagesMap={
  dashboard:document.getElementById('page-dashboard'),
  cards:document.getElementById('page-cards'),
  bills:document.getElementById('page-bills'),
  stats:document.getElementById('page-stats'),
  settings:document.getElementById('page-settings'),
  security:document.getElementById('page-security')
},tableBody=document.getElementById('tableBody'),filterBank=document.getElementById('filterBank'),searchInput=document.getElementById('search'),filterTag=document.getElementById('filterTag'),dashRecentList=document.getElementById('dashRecentList'),dashTotal=document.getElementById('dashTotal'),dashUsed=document.getElementById('dashUsed'),dashRemain=document.getElementById('dashRemain'),dashRecent=document.getElementById('dashRecent');
const billBody=document.getElementById('billBody'),billSearch=document.getElementById('billSearch'),billCardFilter=document.getElementById('billCardFilter');
function uid(){return Date.now().toString(36)+Math.random().toString(36).slice(2,8)}
function saveCards(){localStorage.setItem(LS_CARDS,JSON.stringify(cards))}
function loadCards(){try{cards=JSON.parse(localStorage.getItem(LS_CARDS))||[]}catch(e){cards=[]}}
function saveBills(){localStorage.setItem(LS_BILLS,JSON.stringify(bills))}
function loadBills(){try{bills=JSON.parse(localStorage.getItem(LS_BILLS))||[]}catch(e){bills=[]}}
function saveProfile(p){localStorage.setItem(LS_PROFILE,JSON.stringify(p))}
function loadProfile(){try{return JSON.parse(localStorage.getItem(LS_PROFILE))||{}}catch(e){return {}}}
function saveDefault(id){localStorage.setItem(LS_DEFAULT,id)}
function loadDefault(){return localStorage.getItem(LS_DEFAULT)}
function saveSettings(s){localStorage.setItem(LS_SETTINGS,JSON.stringify(s))}
function loadSettings(){try{return JSON.parse(localStorage.getItem(LS_SETTINGS))||{strong:0}}catch(e){return {strong:0}}}
function savePassword(p){localStorage.setItem(LS_PASSWORD,p)}
function loadPassword(){return localStorage.getItem(LS_PASSWORD)||''}
function formatNumber(v){return v.replace(/\D/g,'').slice(0,19).replace(/(.{4})/g,'$1 ').trim()}
function maskNumber(v){const s=v.replace(/\D/g,'');if(s.length<=8)return s.replace(/.(?=.{4})/g,'*');return s.replace(/\d(?=\d{4})/g,'*').replace(/(.{4})/g,'$1 ').trim()}
function escapeHtml(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}
function luhnCheck(num){const s=num.replace(/\D/g,'');let sum=0,alt=false;for(let i=s.length-1;i>=0;i--){let n=parseInt(s[i],10);if(alt){n*=2;if(n>9)n-=9}sum+=n;alt=!alt}return sum%10===0}
menu.addEventListener('click',e=>{const li=e.target.closest('li');if(!li)return;for(const node of menu.querySelectorAll('li'))node.classList.remove('active');li.classList.add('active');const page=li.dataset.page;for(const k in pagesMap)pagesMap[k].style.display=(k===page)?'block':'none';if(page==='stats')renderStats();if(page==='bills')renderBills();if(page==='cards')render();if(page==='dashboard')render();if(page==='settings')loadProfileToUI();if(page==='security')loadSecurity()});
function highlight(text,q){if(!q)return escapeHtml(text);return escapeHtml(text).replace(new RegExp(`(${q})`,'gi'),'<mark>$1</mark>')}
function collectTags(){const s=new Set();for(const c of cards){(c.tags||[]).forEach(t=>t&&s.add(t.trim()))}return Array.from(s)}
function render(filter=''){const q=filter.trim().toLowerCase();tableBody.innerHTML='';const tagFilter=filterTag.value;const bankFilter=filterBank.value;const list=cards.filter(c=>{if(tagFilter&&!(c.tags||[]).includes(tagFilter))return false;if(bankFilter&&c.bank!==bankFilter)return false;if(!q)return true;return (c.holder||'').toLowerCase().includes(q)||(c.bank||'').toLowerCase().includes(q)||(c.number||'').replace(/\s/g,'').includes(q.replace(/\s/g,''))||((c.tags||[]).join(' ').toLowerCase().includes(q))});for(const c of list){const tr=document.createElement('tr');const tagsHtml=(c.tags||[]).map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join(' ');const soonBadge=isExpiringSoon(c.expMonth,c.expYear)?'<span class="expire-badge">即将到期</span>':'';tr.innerHTML=`<td>${highlight(c.holder||'—',q)}</td><td>${highlight(maskNumber(c.number||''),q)}</td><td>${highlight(c.bank||'—',q)}</td><td>${tagsHtml}</td><td>${escapeHtml(c.note||'')}</td><td>${escapeHtml((c.expMonth||'--')+'/'+(c.expYear||'--'))} ${soonBadge}</td><td class="actions"><button class="btn ghost" data-id="${c.id}" data-action="edit">编辑</button><button class="btn ghost" data-id="${c.id}" data-action="copy">复制</button><button class="btn ghost" data-id="${c.id}" data-action="default">设为默认</button><button class="btn ghost" data-id="${c.id}" data-action="tag">标签管理</button><button class="btn" style="background:var(--danger)" data-id="${c.id}" data-action="del">删除</button><button class="btn ghost" data-id="${c.id}" data-action="genbill">生成账单</button></td>`;tableBody.appendChild(tr)}updateFiltersAndSidebar();renderDashboard()}
tableBody.addEventListener('click',e=>{const btn=e.target.closest('button');if(!btn)return;const id=btn.dataset.id;const action=btn.dataset.action;if(action==='edit')openEdit(id);if(action==='del'){if(confirm('确定删除该卡？')){cards=cards.filter(c=>c.id!==id);saveCards();render(document.getElementById('search').value)}}if(action==='copy'){const c=cards.find(x=>x.id===id);if(c){navigator.clipboard.writeText(c.number).then(()=>alert('卡号已复制'))}}if(action==='default'){saveDefault(id);updateSidebar()}if(action==='tag'){const c=cards.find(x=>x.id===id);if(!c)return;const val=prompt('编辑标签（逗号分隔）', (c.tags||[]).join(','));if(val!==null){c.tags=val.split(',').map(t=>t.trim()).filter(Boolean);saveCards();render(document.getElementById('search').value)}}if(action==='genbill'){generateBillForCard(id);}})
const modalEdit=document.getElementById('modalEdit');
function openEditModal(){modalEdit.style.display='flex'}
function closeEditModal(){modalEdit.style.display='none';editingId=null;document.getElementById('editTitle').textContent='新增信用卡';document.getElementById('holder').value='';document.getElementById('bank').value='';document.getElementById('number').value='';document.getElementById('expMonth').value='';document.getElementById('expYear').value='';document.getElementById('tags').value='';document.getElementById('note').value=''}
document.getElementById('btnNew').addEventListener('click',()=>openEditModal())
function openEdit(id){const c=cards.find(x=>x.id===id);if(!c)return;editingId=id;document.getElementById('editTitle').textContent='编辑信用卡';document.getElementById('holder').value=c.holder||'';document.getElementById('bank').value=c.bank||'';document.getElementById('number').value=formatNumber(c.number||'');document.getElementById('expMonth').value=c.expMonth||'';document.getElementById('expYear').value=c.expYear||'';document.getElementById('tags').value=(c.tags||[]).join(',');document.getElementById('note').value=c.note||'';openEditModal()}
document.getElementById('editCancel').addEventListener('click',()=>closeEditModal())
document.getElementById('number').addEventListener('input',e=>{e.target.value=formatNumber(e.target.value)})
document.getElementById('editSave').addEventListener('click',()=>{const holder=document.getElementById('holder').value.trim(),bank=document.getElementById('bank').value.trim(),number=document.getElementById('number').value.replace(/\s/g,''),expMonth=document.getElementById('expMonth').value.trim(),expYear=document.getElementById('expYear').value.trim(),note=document.getElementById('note').value.trim(),tags=document.getElementById('tags').value.split(',').map(t=>t.trim()).filter(Boolean);if(!holder||!number||!expMonth||!expYear){alert('请填写必填项：持卡人、卡号、到期月、到期年');return}if(!/^\d{12,19}$/.test(number)){alert('卡号需为 12-19 位数字');return}if(!luhnCheck(number)){if(!confirm('Luhn 校验未通过，是否仍然保存？'))return}if(editingId){const idx=cards.findIndex(c=>c.id===editingId);if(idx!==-1){cards[idx]={...cards[idx],holder,bank,number,expMonth,expYear,note,tags}}}else{const obj={id:uid(),holder,bank,number,expMonth,expYear,note,tags,createdAt:new Date().toISOString()};cards.unshift(obj)}saveCards();render(document.getElementById('search').value);closeEditModal()})
document.getElementById('search').addEventListener('input',e=>render(e.target.value))
filterTag.addEventListener('change',()=>render(searchInput.value))
filterBank.addEventListener('change',()=>render(searchInput.value))
document.getElementById('clearBtn').addEventListener('click',()=>{searchInput.value='';filterTag.value='';filterBank.value='';render()})
function updateFiltersAndSidebar(){const tags=collectTags();filterTag.innerHTML=[''].concat(tags).map(t=>`<option value="${escapeHtml(t)}">${t||'全部标签'}</option>`).join('');const banks=Array.from(new Set(cards.map(c=>c.bank).filter(Boolean))).sort();filterBank.innerHTML=[''].concat(banks).map(b=>`<option value="${escapeHtml(b)}">${b||'全部银行'}</option>`).join('');billCardFilter.innerHTML=[''].concat(cards.map(c=>({id:c.id,label:maskNumber(c.number)}))).map(o=>`<option value="${escapeHtml(o.id)}">${o?o.label:'全部卡'}</option>`).join('')}
function renderDashboard(){const total=cards.reduce((s,c)=>s+Number(c.limit||0),0),used=cards.reduce((s,c)=>s+Number(c.used||0),0),remain=total-used;dashTotal.textContent='¥ '+total.toFixed(2);dashUsed.textContent='¥ '+used.toFixed(2);dashRemain.textContent='¥ '+remain.toFixed(2);dashRecent.textContent=cards.length?new Date(cards[0].createdAt).toLocaleDateString():'—';dashRecentList.innerHTML=cards.slice(0,5).map(c=>`<tr><td>${escapeHtml(c.holder||'—')}</td><td>${escapeHtml(maskNumber(c.number||''))}</td><td>${escapeHtml(c.bank||'—')}</td><td>${(c.tags||[]).map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join(' ')}</td><td>${escapeHtml((c.expMonth||'--')+'/'+(c.expYear||'--'))}</td></tr>`).join('')}
function renderStats(){const ctx=document.getElementById('bankChart').getContext('2d');const counts={};for(const c of cards){if(!c.bank)continue;counts[c.bank]=(counts[c.bank]||0)+1}const banks=Object.keys(counts),values=banks.map(b=>counts[b]),max=Math.max(1,...values);ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);const w=ctx.canvas.width,h=ctx.canvas.height,padding=40,chartW=w-padding*2,chartH=h-padding*2;ctx.fillStyle='#fff';ctx.fillRect(0,0,w,h);ctx.fillStyle='#94a3b8';ctx.font='12px sans-serif';const barW=banks.length?(chartW/banks.length*0.6):0;banks.forEach((b,i)=>{const x=padding+i*(chartW/banks.length)+(chartW/banks.length-barW)/2,constBarH=(values[i]/max)*(chartH-20);const barH=constBarH;const y=padding+(chartH-barH);ctx.fillStyle='#1e3a8a';ctx.fillRect(x,y,barW,barH);ctx.fillStyle='#334155';ctx.textAlign='center';ctx.fillText(b,x+barW/2,padding+chartH+14);ctx.fillText(values[i],x+barW/2,y-6)});if(banks.length===0){ctx.fillStyle='#64748b';ctx.textAlign='center';ctx.fillText('无数据',w/2,h/2)};document.getElementById('statCount').textContent=cards.length;document.getElementById('statBanks').textContent=banks.length;document.getElementById('statTagged').textContent=cards.filter(c=>(c.tags||[]).length>0).length}
function isExpiringSoon(mm,yy){if(!mm||!yy)return false;const y=2000+parseInt(yy,10),m=parseInt(mm,10);if(isNaN(y)||isNaN(m))return false;const exp=new Date(y,m-1,1),now=new Date(),diff=(exp-now)/(1000*60*60*24*30);return diff>=0 && diff<=3}
function updateSidebar(){const def=loadDefault();if(def){const c=cards.find(x=>x.id===def);document.getElementById('defaultCard').textContent=c?(c.holder+' · '+maskNumber(c.number)):'未设置'}else document.getElementById('defaultCard').textContent='未设置';const soon=cards.filter(c=>isExpiringSoon(c.expMonth,c.expYear));document.getElementById('expireNotice').textContent=soon.length?soon.length+' 张卡即将到期':'无即将到期的卡'}
function renderBills(filter=''){const q=filter.trim().toLowerCase();billBody.innerHTML='';const cardFilter=billCardFilter.value;const list=bills.filter(b=>{if(cardFilter&&b.cardId!==cardFilter)return false;const card=(cards.find(c=>c.id===b.cardId)||{});if(!q)return true;return (card.number||'').replace(/\s/g,'').includes(q.replace(/\s/g,''))||String(b.period).includes(q)||String(b.status||'').toLowerCase().includes(q)});for(const b of list){const card=cards.find(c=>c.id===b.cardId)||{};const tr=document.createElement('tr');tr.innerHTML=`<td>${escapeHtml(maskNumber(card.number||''))}</td><td>${escapeHtml(b.period)}</td><td>¥ ${Number(b.amount||0).toFixed(2)}</td><td>${escapeHtml(b.dueDate||'—')}</td><td>${escapeHtml(b.status||'未还')}</td><td><button class="btn ghost" data-id="${b.id}" data-act="pay">标记已还</button><button class="btn ghost" data-id="${b.id}" data-act="delbill" style="background:var(--danger)">删除</button></td>`;billBody.appendChild(tr)}}
document.getElementById('genAllBills').addEventListener('click',()=>{for(const c of cards)generateBillForCard(c.id);saveBills();renderBills();alert('已为所有卡生成本月账单')})
function generateBillForCard(cardId){const amount=(Math.random()*500+100).toFixed(2);const period=new Date().toISOString().slice(0,7);const due=new Date();due.setMonth(due.getMonth()+1);const obj={id:uid(),cardId,period,amount:Number(amount),dueDate:due.toISOString().slice(0,10),status:'未还',createdAt:new Date().toISOString()};bills.unshift(obj);saveBills();renderBills()}
billBody.addEventListener('click',e=>{const btn=e.target.closest('button');if(!btn)return;const id=btn.dataset.id;const act=btn.dataset.act;if(act==='pay'){const idx=bills.findIndex(x=>x.id===id);if(idx!==-1){bills[idx].status='已还';saveBills();renderBills();alert('已标记已还')}}if(act==='delbill'){if(confirm('删除此账单？')){bills=bills.filter(x=>x.id!==id);saveBills();renderBills()}}})
document.getElementById('billSearch').addEventListener('input',e=>renderBills(e.target.value))
billCardFilter.addEventListener('change',()=>renderBills(billSearch.value))
document.getElementById('quickUnpaid').addEventListener('click',()=>{for(const node of menu.querySelectorAll('li'))node.classList.remove('active');menu.querySelector('li[data-page="bills"]').classList.add('active');for(const k in pagesMap)pagesMap[k].style.display=(k==='bills')?'block':'none';renderBills();billSearch.value='';billCardFilter.value='';const list=bills.filter(b=>b.status!=='已还');if(list.length>0){renderBills();alert('已显示未还账单')}else{alert('暂无未还账单')}})
document.getElementById('quickPaid').addEventListener('click',()=>{for(const node of menu.querySelectorAll('li'))node.classList.remove('active');menu.querySelector('li[data-page="bills"]').classList.add('active');for(const k in pagesMap)pagesMap[k].style.display=(k==='bills')?'block':'none';renderBills();billSearch.value='';billCardFilter.value='';const list=bills.filter(b=>b.status==='已还');if(list.length>0){renderBills();alert('已显示已还账单')}else{alert('暂无已还账单')}})
document.getElementById('saveProfile').addEventListener('click',()=>{const email=document.getElementById('profileEmail').value.trim();if(email && !/^[\w.-]+@[\w.-]+\.[A-Za-z]{2,}$/.test(email)){alert('请输入有效邮箱');return}const p={name:document.getElementById('profileName').value.trim(),email};saveProfile(p);alert('已保存');document.getElementById('currentUser').textContent=p.name||'用户'})
function loadProfileToUI(){const p=loadProfile();document.getElementById('profileName').value=p.name||'';document.getElementById('profileEmail').value=p.email||'';document.getElementById('currentUser').textContent=p.name||'用户'}
function loadSecurity(){const s=loadSettings();document.getElementById('strongToggle').value=s.strong?1:0}
document.getElementById('savePassword').addEventListener('click',()=>{const old= document.getElementById('pwOld').value.trim(),nw=document.getElementById('pwNew').value.trim();const saved=loadPassword();if(saved && old!==saved){alert('旧密码错误');return}const s=loadSettings();if(s.strong){if(!/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[^A-Za-z0-9]).{8,}$/.test(nw)){alert('新密码不符合强密码要求');return}}savePassword(nw);alert('密码已修改');document.getElementById('pwOld').value='';document.getElementById('pwNew').value=''})
document.getElementById('strongToggle').addEventListener('change',e=>{const s={strong: e.target.value==='1'?1:0};saveSettings(s);alert('已更新安全设置')})
document.getElementById('clearAll').addEventListener('click',()=>{if(confirm('确定要清空所有数据吗？')){localStorage.removeItem(LS_CARDS);localStorage.removeItem(LS_BILLS);localStorage.removeItem(LS_DEFAULT);cards=[];bills=[];render();renderBills();updateSidebar();alert('已清空')}})
document.getElementById('seedBtn').addEventListener('click',()=>{if(confirm('确定重建示例数据吗？')){localStorage.removeItem(LS_CARDS);localStorage.removeItem(LS_BILLS);localStorage.removeItem(LS_DEFAULT);initSeed();loadCards();loadBills();render();renderBills();alert('已重建示例数据')}})
document.getElementById('btnExport').addEventListener('click',()=>{const data=JSON.stringify({cards,bills,profile:loadProfile(),settings:loadSettings()},null,2);const blob=new Blob([data],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='cc_data_backup.json';a.click();URL.revokeObjectURL(url)})
document.getElementById('btnImport').addEventListener('click',()=>{const inp=document.createElement('input');inp.type='file';inp.accept='application/json';inp.onchange=()=>{const f=inp.files[0];if(!f) return;const reader=new FileReader();reader.onload=()=>{try{const data=JSON.parse(reader.result);if(Array.isArray(data.cards))cards=data.cards; if(Array.isArray(data.bills))bills=data.bills; if(data.profile)saveProfile(data.profile); if(data.settings)saveSettings(data.settings); saveCards(); saveBills(); render(); renderBills(); alert('导入完成')}catch(err){alert('导入失败: 文件格式错误')}};reader.readAsText(f)};inp.click()})
function seedIfEmpty(){loadCards();loadBills();if(cards.length===0 && bills.length===0)initSeed();loadCards();loadBills()}
function initSeed(){cards=[{id:uid(),holder:'ZHANG SAN',number:'4111111111111111',bank:'示例银行',expMonth:'12',expYear:'26',note:'测试卡',tags:['示例'],createdAt:new Date().toISOString(),limit:20000,used:5200},{id:uid(),holder:'LI HUA',number:'5555555555554444',bank:'国内银行',expMonth:'06',expYear:'27',note:'工资卡',tags:['工资'],createdAt:new Date().toISOString(),limit:10000,used:3000}];bills=[{id:uid(),cardId:cards[0].id,period:new Date().toISOString().slice(0,7),amount:3200,dueDate:new Date(Date.now()+1000*60*60*24*15).toISOString().slice(0,10),status:'未还',createdAt:new Date().toISOString()}];saveCards();saveBills()}
document.getElementById('billCardFilter').addEventListener('change',()=>renderBills(billSearch.value))
document.getElementById('billSearch').addEventListener('input',e=>renderBills(e.target.value))
seedIfEmpty();render();renderBills();updateSidebar();renderStats()
document.getElementById('modalEdit').addEventListener('click',e=>{if(e.target===document.getElementById('modalEdit'))closeEditModal()})
</script>
</body>
</html>
